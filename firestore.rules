rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ==========================================================================
    // SECURITY RULES FOR ZERO CLICK
    // ==========================================================================
    //
    // These rules restrict direct Firestore access from clients.
    // The API (Cloud Run) uses a service account that bypasses these rules.
    //
    // Client access is only allowed for authenticated users to their own data.
    // Backend-only collections are fully restricted from client access.
    // ==========================================================================

    // Trips collection - user can only access their own trips
    match /trips/{tripId} {
      allow read: if request.auth != null &&
        resource.data.user_id == request.auth.token.email;
      allow create: if request.auth != null &&
        request.resource.data.user_id == request.auth.token.email;
      allow update, delete: if request.auth != null &&
        resource.data.user_id == request.auth.token.email;
    }

    // Users collection - user can only access their own user document
    match /users/{userId} {
      allow read, write: if request.auth != null &&
        request.auth.token.email == userId;

      // Subcollections under users (cars, settings, etc.)
      match /{subcollection=**} {
        allow read, write: if request.auth != null &&
          request.auth.token.email == userId;
      }
    }

    // Locations collection - user can only access their own locations
    match /locations/{locationId} {
      allow read: if request.auth != null &&
        resource.data.user_id == request.auth.token.email;
      allow create: if request.auth != null &&
        request.resource.data.user_id == request.auth.token.email;
      allow update, delete: if request.auth != null &&
        resource.data.user_id == request.auth.token.email;
    }

    // ==========================================================================
    // BACKEND-ONLY COLLECTIONS (no client access)
    // ==========================================================================

    // Refresh tokens - only accessible by backend service account
    match /refresh_tokens/{doc} {
      allow read, write: if false;
    }

    // Cache collection - only accessible by backend service account
    match /cache/{doc} {
      allow read, write: if false;
    }

    // Active trips state - only accessible by backend service account
    match /active_trips/{doc} {
      allow read, write: if false;
    }

    // ==========================================================================
    // DEFAULT DENY
    // ==========================================================================
    // Any collection not explicitly matched above is denied
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
