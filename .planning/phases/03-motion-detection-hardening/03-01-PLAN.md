---
phase: 03-motion-detection-hardening
plan: 01
type: execute
depends_on: []
files_modified: [mobile/ios/Runner/Services/MotionActivityHandler.swift, mobile/ios/Runner/Services/MotionActivityHandlerProtocol.swift, mobile/ios/RunnerTests/Mocks/MockMotionActivityHandler.swift, mobile/ios/RunnerTests/MotionDetectionTests.swift]
---

<objective>
Harden motion detection with configurable confidence thresholds and debouncing.

Purpose: Prevent false trip starts/stops from rapid motion state oscillation (walk to car, car in traffic).
Output: MotionActivityHandler with configurable thresholds, debounce logic, and verified by tests.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@mobile/ios/Runner/Services/MotionActivityHandler.swift
@mobile/ios/Runner/Services/MotionActivityHandlerProtocol.swift
@mobile/ios/RunnerTests/Mocks/MockMotionActivityHandler.swift
@mobile/ios/RunnerTests/TripLifecycleTests.swift

**Tech stack available:** Swift, CMMotionActivity, XCTest, protocol-based services
**Established patterns:** Service protocols with delegate pattern, mock implementations for testing
**Prior context:** Phase 2 extracted MotionActivityHandler from AppDelegate. Phase 2.1 created testing infrastructure.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add configurable confidence and debounce settings to protocol</name>
  <files>mobile/ios/Runner/Services/MotionActivityHandlerProtocol.swift</files>
  <action>
Add configuration properties to MotionActivityHandlerProtocol:
- `var minimumConfidence: CMMotionActivityConfidence { get set }` - threshold for accepting activity updates (default: .medium)
- `var automotiveDebounceSeconds: TimeInterval { get set }` - time to wait before confirming automotive start (default: 2.0)
- `var nonAutomotiveDebounceSeconds: TimeInterval { get set }` - time to wait before confirming automotive end (default: 3.0)

Add new delegate method to MotionActivityHandlerDelegate:
- `func motionHandler(_ handler: MotionActivityHandlerProtocol, didConfirmAutomotive isAutomotive: Bool)` - called after debounce confirms state

Keep existing `didDetectAutomotive` for immediate detection, add new `didConfirmAutomotive` for debounced confirmation. This allows AppDelegate to choose which to respond to.
  </action>
  <verify>Build succeeds: `cd mobile/ios && xcodebuild -project Runner.xcodeproj -scheme Runner -sdk iphonesimulator -destination 'platform=iOS Simulator,name=iPhone 16' build 2>&1 | tail -5`</verify>
  <done>Protocol has minimumConfidence, automotiveDebounceSeconds, nonAutomotiveDebounceSeconds properties and didConfirmAutomotive delegate method</done>
</task>

<task type="auto">
  <name>Task 2: Implement debounce logic in MotionActivityHandler</name>
  <files>mobile/ios/Runner/Services/MotionActivityHandler.swift</files>
  <action>
Implement the new protocol requirements:

1. Add configuration properties with defaults:
   - `var minimumConfidence: CMMotionActivityConfidence = .medium`
   - `var automotiveDebounceSeconds: TimeInterval = 2.0`
   - `var nonAutomotiveDebounceSeconds: TimeInterval = 3.0`

2. Add debounce state tracking:
   - `private var pendingAutomotiveChange: Bool?` - the pending confirmed state
   - `private var debounceTimer: Timer?` - for debounce timing
   - `private var lastStateChangeTime: Date?` - track when last change occurred

3. Update `processActivity()`:
   - Check `activity.confidence.rawValue >= minimumConfidence.rawValue` instead of just `!= .low`
   - When automotive detected:
     - Call existing `didDetectAutomotive(true)` immediately
     - Start debounce timer for `automotiveDebounceSeconds`
     - After timer: call `didConfirmAutomotive(true)` if still automotive
   - When non-automotive detected (stationary/walking/running):
     - Call existing `didDetectAutomotive(false)` immediately
     - Start debounce timer for `nonAutomotiveDebounceSeconds`
     - After timer: call `didConfirmAutomotive(false)` if still not automotive

4. Add `cancelPendingDebounce()` method to reset pending state if needed.

Key: Debounce prevents rapid oscillation. If user walks to car (walking) then gets in (automotive) then sits still momentarily (stationary), we don't want trip to end immediately on stationary - wait for debounce.
  </action>
  <verify>Build succeeds: `cd mobile/ios && xcodebuild -project Runner.xcodeproj -scheme Runner -sdk iphonesimulator -destination 'platform=iOS Simulator,name=iPhone 16' build 2>&1 | tail -5`</verify>
  <done>MotionActivityHandler implements configurable confidence threshold, debounce timers, and fires didConfirmAutomotive after debounce period</done>
</task>

<task type="auto">
  <name>Task 3: Add motion detection debounce tests</name>
  <files>mobile/ios/RunnerTests/MotionDetectionTests.swift, mobile/ios/RunnerTests/Mocks/MockMotionActivityHandler.swift</files>
  <action>
1. Update MockMotionActivityHandler:
   - Add `minimumConfidence`, `automotiveDebounceSeconds`, `nonAutomotiveDebounceSeconds` properties
   - Add `didConfirmAutomotive` tracking
   - Add methods to simulate confidence levels: `simulateWithConfidence(_ state: MotionState, confidence: CMMotionActivityConfidence)`

2. Create new test file MotionDetectionTests.swift with XCTests:

   **Confidence threshold tests:**
   - `testLowConfidenceIgnored()` - low confidence activities don't trigger state changes
   - `testMediumConfidenceAccepted()` - medium confidence accepted with default threshold
   - `testCustomThresholdRespected()` - setting minimumConfidence to .high rejects .medium

   **Debounce tests:**
   - `testAutomotiveDebounce()` - automotive detected immediately, confirmed after delay
   - `testRapidOscillationIgnored()` - automotive → stationary → automotive within debounce doesn't end trip
   - `testWalkingEndsTrip()` - walking activity (different from stationary) ends trip after debounce
   - `testStationaryDebounceDelaysEnd()` - stationary alone waits full debounce before ending

   **Integration tests:**
   - `testWalkToCarScenario()` - walking → automotive: trip starts, no false end
   - `testTrafficScenario()` - automotive → stationary → automotive: trip continues
   - `testParkingScenario()` - automotive → stationary for 5s: trip ends

Use XCTestExpectation with timeout for async debounce verification.
  </action>
  <verify>Tests pass: `cd mobile/ios && xcodebuild test -project Runner.xcodeproj -scheme Runner -sdk iphonesimulator -destination 'platform=iOS Simulator,name=iPhone 16' -only-testing:RunnerTests/MotionDetectionTests 2>&1 | grep -E '(Test Case|passed|failed)'`</verify>
  <done>MotionDetectionTests.swift exists with 9+ tests covering confidence thresholds, debouncing, and edge case scenarios, all passing</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `xcodebuild build` succeeds for Runner scheme
- [ ] `xcodebuild test` passes for MotionDetectionTests
- [ ] Protocol has new configuration properties
- [ ] MotionActivityHandler implements debounce logic
- [ ] MockMotionActivityHandler updated for testing
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Motion detection has configurable confidence (default: .medium)
- Automotive start debounces for 2 seconds
- Non-automotive end debounces for 3 seconds
- Tests verify debounce prevents false trip starts/stops
</success_criteria>

<output>
After completion, create `.planning/phases/03-motion-detection-hardening/03-01-SUMMARY.md`:

# Phase 03 Plan 01: Motion Detection Debouncing Summary

**[Substantive one-liner]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 03-02-PLAN.md (edge case tests and documentation)
</output>
