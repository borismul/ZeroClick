---
phase: 04-flutter-provider-split
plan: 04
type: execute
depends_on: ["04-03"]
files_modified: [mobile/lib/providers/trip_provider.dart, mobile/lib/providers/app_provider.dart, mobile/lib/main.dart]
---

<objective>
Extract TripProvider from AppProvider - trip lifecycle, CRUD, and active trip management.

Purpose: Trip management is the core domain of the app. After extracting Settings, Cars, and Connectivity, what remains in AppProvider is primarily trip-related. TripProvider will own trip state and operations, making AppProvider a thin orchestrator.
Output: TripProvider managing active trip, trip history, stats, locations, and webhook operations.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-flutter-provider-split/04-01-SUMMARY.md
@.planning/phases/04-flutter-provider-split/04-02-SUMMARY.md
@.planning/phases/04-flutter-provider-split/04-03-SUMMARY.md
@mobile/lib/providers/app_provider.dart
@mobile/lib/models/trip.dart
@mobile/lib/services/api_service.dart
@mobile/lib/services/background_service.dart
@mobile/lib/services/location_service.dart

**From prior plans:**
- SettingsProvider, CarProvider, ConnectivityProvider extracted
- AppProvider now a thinner coordinator
- Cross-provider callbacks established

**Trip-related code remaining in AppProvider:**
- State: `_activeTrip`, `_trips`, `_stats`, `_locations`, `_isLoading`, `_error`, loading states
- Services: `_api`, `_location`, `_background`, `_notifications`
- Refresh: `refreshActiveTrip`, `refreshTrips`, `refreshStats`, `refreshLocations`, `refreshAll`
- CRUD: `createTrip`, `updateTrip`, `deleteTrip`
- Locations: `isKnownLocation`, `addLocation`
- Webhooks: `startTrip`, `endTrip`, `sendPing`, `finalizeTrip`, `cancelTrip`, `startTripForCar`
- Account: `deleteAccount`
- Navigation: `_navigationIndex`, `navigateTo`
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TripProvider with trip lifecycle management</name>
  <files>mobile/lib/providers/trip_provider.dart</files>
  <action>
Create new TripProvider extending ChangeNotifier with:

**Constructor:**
- Accept dependencies: `ApiService`, `CarProvider`, `ConnectivityProvider`
- `TripProvider(this._api, this._carProvider, this._connectivityProvider)`
- Create internal services: `_location = LocationService()`, `_background = BackgroundService()`, `_notifications = NotificationService()`

**State to move from AppProvider:**
- `ActiveTrip? _activeTrip`
- `List<Trip> _trips = []`
- `Stats? _stats`
- `List<UserLocation> _locations = []`
- `bool _isLoading = false`
- `String? _error`
- Loading states: `_isLoadingStats`, `_isLoadingTrips`

**Getters:**
- `activeTrip`, `trips`, `stats`, `locations`
- `isLoading`, `isLoadingStats`, `isLoadingTrips`
- `error`
- `isTrackingLocation` (from LocationService)

**Data refresh methods:**
- `refreshActiveTrip()`
- `refreshTrips()` - uses `_carProvider.selectedCarId` for filtering
- `refreshStats()` - uses `_carProvider.selectedCarId` for filtering
- `refreshLocations()`
- `refreshAll()` - coordinates all refreshes

**Trip CRUD:**
- `createTrip(Map<String, dynamic> tripData)`
- `updateTrip(String tripId, Map<String, dynamic> updates)`
- `deleteTrip(String tripId)`

**Location management:**
- `isKnownLocation(String? address)`
- `addLocation({name, lat, lng})`

**Webhook operations (core trip lifecycle):**
- `startTrip()` - the manual start method
- `startTripForCar(Car car, String deviceId)` - specific car start
- `endTrip()`
- `sendPing()`
- `finalizeTrip()`
- `cancelTrip()`

**Helper methods:**
- `clearError()`
- `_checkAndResumeTracking()` - called during init

**Callbacks for coordination:**
- `VoidCallback? onTripStarted` - AppProvider sets to update UI
- `VoidCallback? onTripEnded` - AppProvider sets to update UI

**Background service setup:**
- `setupBackgroundListener()` - moved from AppProvider's `_setupBackgroundListener`
- Handles car detection callbacks

**Account:**
- `deleteAccount()` - API call for account deletion

Total ~400-450 lines expected (this is the largest provider, core domain).
  </action>
  <verify>File compiles: `cd mobile && flutter analyze lib/providers/trip_provider.dart`</verify>
  <done>TripProvider exists with all trip state, lifecycle, CRUD, and webhook operations</done>
</task>

<task type="auto">
  <name>Task 2: Reduce AppProvider to thin orchestrator</name>
  <files>mobile/lib/providers/app_provider.dart</files>
  <action>
Transform AppProvider into a thin orchestrator that coordinates providers:

1. **Add TripProvider dependency:**
   - Add `final TripProvider _tripProvider;` field
   - Update constructor: `AppProvider(this._settingsProvider, this._carProvider, this._connectivityProvider, this._tripProvider)`

2. **Remove trip state from AppProvider:**
   - Remove: `_activeTrip`, `_trips`, `_stats`, `_locations`
   - Remove: `_isLoading`, `_error`, all loading states
   - Remove: `_api`, `_location`, `_background`, `_notifications` services

3. **Remove trip methods:**
   - Remove: All refresh methods
   - Remove: All trip CRUD methods
   - Remove: All webhook methods
   - Remove: Location methods
   - Remove: `_setupBackgroundListener`, `_checkAndResumeTracking`
   - Remove: `deleteAccount`

4. **What remains in AppProvider (orchestration only):**
   - Navigation: `_navigationIndex`, `navigateTo()`
   - Auto-start orchestration: `_tryAutoStartTrip()` - coordinates CarProvider + TripProvider
   - Device linking: `linkDeviceAndStartTrip()` - updates car, starts trip
   - Native sync: `_syncCarIdToNative()` - uses TripProvider's BackgroundService
   - Delegating getters for backward compatibility (optional)

5. **Simplify _init():**
   ```dart
   Future<void> _init() async {
     // Auth setup
     final auth = AuthService();
     await auth.init();

     // Sync auth to API
     if (auth.isSignedIn && auth.accessToken != null) {
       _api.setAuthToken(auth.accessToken);  // Get _api from context or pass in
     }

     // Set up cross-provider callbacks
     _connectivityProvider.onCarPlayConnected = _tryAutoStartTrip;
     _connectivityProvider.onBluetoothDeviceConnected = (deviceName) {
       _syncCarIdToNative(deviceName);
       _tryAutoStartTrip();
     };

     // Start TripProvider initialization
     await _tripProvider.init();
   }
   ```

6. **Consider: Does AppProvider even need to exist?**
   - If only orchestration remains (~50-100 lines), consider inlining into main.dart
   - For now, keep it as coordinator for the complex auto-start logic
   - Future: Could become `TripOrchestrator` or merge into TripProvider

AppProvider should shrink to ~100-150 lines (from 954).
  </action>
  <verify>
1. `cd mobile && flutter analyze lib/providers/app_provider.dart` - no errors
2. Line count: `wc -l mobile/lib/providers/app_provider.dart` should be under 200
3. Trip code removed: `grep -c "refreshTrips\|startTrip\|endTrip" mobile/lib/providers/app_provider.dart` shows minimal (only delegation if any)
  </verify>
  <done>AppProvider is thin orchestrator. Trip state and operations in TripProvider.</done>
</task>

<task type="auto">
  <name>Task 3: Update provider tree and screen consumers</name>
  <files>mobile/lib/main.dart</files>
  <action>
Update main.dart and verify all screens work:

1. **Add TripProvider to MultiProvider:**
   ```dart
   ChangeNotifierProvider(
     create: (context) => TripProvider(
       context.read<ApiService>(),
       context.read<CarProvider>(),
       context.read<ConnectivityProvider>(),
     )..init(),
   ),
   ```

2. **Update AppProvider creation (final form):**
   ```dart
   ChangeNotifierProvider(
     create: (context) => AppProvider(
       context.read<SettingsProvider>(),
       context.read<CarProvider>(),
       context.read<ConnectivityProvider>(),
       context.read<TripProvider>(),
     ),
   ),
   ```

3. **Final provider order:**
   SettingsProvider -> ApiService -> CarProvider -> ConnectivityProvider -> TripProvider -> AppProvider

4. **Update screen consumers:**
   - Find screens using trip methods: `grep -r "refreshTrips\|startTrip\|activeTrip\|refreshStats" mobile/lib/screens/`
   - Dashboard: Use `context.watch<TripProvider>()` for activeTrip, stats
   - History: Use `context.watch<TripProvider>()` for trips list
   - Trip actions: Use `context.read<TripProvider>().startTrip()` etc.

   Common pattern change:
   ```dart
   // Before
   final provider = context.watch<AppProvider>();
   final trips = provider.trips;

   // After
   final tripProvider = context.watch<TripProvider>();
   final trips = tripProvider.trips;
   ```

5. **Backward compatibility option:**
   If too many screen changes, add delegating getters to AppProvider:
   ```dart
   List<Trip> get trips => _tripProvider.trips;
   ActiveTrip? get activeTrip => _tripProvider.activeTrip;
   ```
   This allows gradual migration of screens.

6. **Verify import in main.dart:**
   ```dart
   import 'providers/trip_provider.dart';
   ```
  </action>
  <verify>
1. `cd mobile && flutter analyze` - no errors across all files
2. `cd mobile && flutter build ios --debug` - builds successfully
3. Total provider line counts are reasonable:
   - SettingsProvider: ~100-150 lines
   - CarProvider: ~300-350 lines
   - ConnectivityProvider: ~250-300 lines
   - TripProvider: ~400-450 lines
   - AppProvider: ~100-150 lines
   - Total: ~1200-1400 lines across 5 files (was 954 in one file)
  </verify>
  <done>All providers integrated, screens updated, app builds and runs</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd mobile && flutter analyze` passes with no errors
- [ ] `cd mobile && flutter build ios --debug` succeeds
- [ ] AppProvider is under 200 lines
- [ ] TripProvider is under 500 lines
- [ ] All providers follow established conventions
- [ ] Trip lifecycle works (start trip manually, end trip)
- [ ] Dashboard shows active trip and stats
</verification>

<success_criteria>
- TripProvider exists and manages all trip state and operations
- AppProvider is thin orchestrator (<200 lines)
- All 4 new providers work together correctly
- No single provider exceeds 500 lines
- App builds, runs, and trip tracking works end-to-end
- Phase 4 complete
</success_criteria>

<output>
After completion, create `.planning/phases/04-flutter-provider-split/04-04-SUMMARY.md`

This completes Phase 4: Flutter Provider Split.
Update STATE.md to reflect Phase 4 completion.
</output>
