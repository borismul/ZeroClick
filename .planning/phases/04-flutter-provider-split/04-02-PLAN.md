---
phase: 04-flutter-provider-split
plan: 02
type: execute
depends_on: ["04-01"]
files_modified: [mobile/lib/providers/car_provider.dart, mobile/lib/providers/app_provider.dart, mobile/lib/main.dart]
---

<objective>
Extract CarProvider from AppProvider - car management, credentials, and OAuth flows.

Purpose: Car management is a distinct domain (CRUD, OAuth flows for 5+ brands) that clutters AppProvider. CarProvider will own all car-related state and API calls.
Output: CarProvider managing cars list, selected car, credentials, and brand-specific OAuth.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-flutter-provider-split/04-01-SUMMARY.md
@mobile/lib/providers/app_provider.dart
@mobile/lib/models/car.dart
@mobile/lib/services/api_service.dart

**From 04-01:**
- SettingsProvider pattern established
- AppProvider now takes dependencies via constructor

**Car-related code in AppProvider (lines 634-768):**
- State: `_cars`, `_selectedCar`, `_selectedCarId`, `_isLoadingCars`, `_isLoadingCarData`, `_carData`
- Methods: `refreshCars`, `selectCar`, `createCar`, `updateCar`, `deleteCar`
- Credentials: `saveCarCredentials`, `getCarCredentials`, `deleteCarCredentials`, `testCarCredentials`
- OAuth: Tesla, Audi, VW Group, Renault auth methods
- Helper: `findCarByDeviceId`
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CarProvider with car management</name>
  <files>mobile/lib/providers/car_provider.dart</files>
  <action>
Create new CarProvider extending ChangeNotifier with:

**Constructor:**
- Accept `ApiService` as dependency (will be passed from AppProvider initially)
- `CarProvider(this._api)`

**State to move from AppProvider:**
- `List<Car> _cars = []`
- `Car? _selectedCar`
- `String? _selectedCarId`
- `bool _isLoadingCars = true`
- `bool _isLoadingCarData = true`
- `CarData? _carData`

**Getters to move:**
- `cars`, `selectedCar`, `selectedCarId`, `defaultCar`
- `isLoadingCars`, `isLoadingCarData`, `carData`

**Methods to move:**
- `refreshCars()` - loads cars from API, auto-selects default
- `selectCar(Car car)` - sets selected car, triggers data refresh
- `createCar(...)` - creates car via API
- `updateCar(...)` - updates car via API
- `deleteCar(...)` - deletes car via API, clears selection if needed
- `refreshCarData()` - loads car data (odometer etc) for selected car

**Credential methods to move:**
- `saveCarCredentials(carId, creds)`
- `getCarCredentials(carId)`
- `deleteCarCredentials(carId)`
- `testCarCredentials(carId, creds)`

**OAuth methods to move (all brand-specific):**
- Tesla: `getTeslaAuthUrl`, `completeTeslaAuth`
- Audi: `getAudiAuthUrl`, `completeAudiAuth`
- VW Group: `getVWGroupAuthUrl`, `completeVWGroupAuth`
- Renault: `renaultDirectLogin`, `getRenaultAuthUrl`, `completeRenaultAuth`

**Helper to move:**
- `findCarByDeviceId(deviceId)` - used by Bluetooth matching

**New additions:**
- `static const _log = AppLogger('CarProvider')`
- Import statements for Car, CarData, CarCredentials models

Total ~300-350 lines expected.
  </action>
  <verify>File compiles: `cd mobile && flutter analyze lib/providers/car_provider.dart`</verify>
  <done>CarProvider exists with all car state, CRUD, credentials, and OAuth methods</done>
</task>

<task type="auto">
  <name>Task 2: Update AppProvider to delegate to CarProvider</name>
  <files>mobile/lib/providers/app_provider.dart</files>
  <action>
Modify AppProvider to use CarProvider:

1. **Add CarProvider dependency:**
   - Add `final CarProvider _carProvider;` field
   - Update constructor: `AppProvider(this._settingsProvider, this._carProvider)`

2. **Remove car state from AppProvider:**
   - Remove: `_cars`, `_selectedCar`, `_selectedCarId`, `_isLoadingCars`, `_isLoadingCarData`, `_carData`
   - Remove all car-related getters

3. **Remove car methods from AppProvider:**
   - Remove: `refreshCars`, `selectCar`, `createCar`, `updateCar`, `deleteCar`
   - Remove: `refreshCarData`
   - Remove: All credential methods
   - Remove: All OAuth methods
   - Remove: `findCarByDeviceId`

4. **Update references throughout AppProvider:**
   - `_cars` -> `_carProvider.cars`
   - `_selectedCar` -> `_carProvider.selectedCar`
   - `_selectedCarId` -> `_carProvider.selectedCarId`
   - `defaultCar` -> `_carProvider.defaultCar`
   - `findCarByDeviceId(...)` -> `_carProvider.findCarByDeviceId(...)`

5. **Update refreshAll():**
   - Replace `await refreshCars()` with `await _carProvider.refreshCars()`
   - Replace `await refreshCarData()` with `await _carProvider.refreshCarData()`

6. **Keep in AppProvider (uses car data but doesn't manage it):**
   - `_syncCarIdToNative` - uses `findCarByDeviceId` result
   - Trip start logic - uses `selectedCar`, `defaultCar`
   - Bluetooth device linking - calls `_carProvider.updateCar`

AppProvider should shrink by ~200 lines from this extraction.
  </action>
  <verify>
1. `cd mobile && flutter analyze lib/providers/app_provider.dart` - no errors
2. Search for removed methods: `grep -c "refreshCars\|selectCar\|createCar" mobile/lib/providers/app_provider.dart` should be 0 (or only delegation calls)
  </verify>
  <done>AppProvider delegates all car operations to CarProvider. Car state and methods removed from AppProvider.</done>
</task>

<task type="auto">
  <name>Task 3: Update provider setup and screen consumers</name>
  <files>mobile/lib/main.dart</files>
  <action>
Update main.dart MultiProvider setup:

1. **Add CarProvider after SettingsProvider:**
   The challenge: CarProvider needs ApiService, which is currently created inside AppProvider.

   **Option A (Recommended):** Create ApiService in main.dart and inject:
   ```dart
   Provider<ApiService>(
     create: (context) {
       final settings = context.read<SettingsProvider>().settings;
       return ApiService(baseUrl: settings.apiUrl, userEmail: settings.userEmail);
     },
   ),
   ChangeNotifierProvider(
     create: (context) => CarProvider(context.read<ApiService>()),
   ),
   ```

   **Option B:** Let CarProvider create its own ApiService (less ideal, duplicates service)

2. **Update AppProvider creation:**
   ```dart
   ChangeNotifierProvider(
     create: (context) => AppProvider(
       context.read<SettingsProvider>(),
       context.read<CarProvider>(),
     ),
   ),
   ```

3. **Verify import:**
   ```dart
   import 'providers/car_provider.dart';
   ```

4. **Check screen files that use car methods** (likely cars_screen.dart):
   - If they call `context.read<AppProvider>().createCar(...)`, they should now call `context.read<CarProvider>().createCar(...)`
   - Quick grep to find: `grep -r "createCar\|updateCar\|deleteCar\|refreshCars" mobile/lib/screens/`
   - Update those calls to use CarProvider directly

Provider order: SettingsProvider -> ApiService -> CarProvider -> AppProvider
  </action>
  <verify>
1. `cd mobile && flutter analyze` - no errors across all files
2. `cd mobile && flutter build ios --debug` - builds successfully
  </verify>
  <done>CarProvider in provider tree, screens use CarProvider for car operations</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd mobile && flutter analyze` passes with no errors
- [ ] `cd mobile && flutter build ios --debug` succeeds
- [ ] CarProvider is ~300-350 lines (not over 400)
- [ ] AppProvider car code removed (grep for OAuth methods returns 0)
- [ ] Cars screen uses CarProvider directly
</verification>

<success_criteria>
- CarProvider exists and manages all car state and operations
- AppProvider delegates to CarProvider (no direct car management)
- OAuth flows work (can test Audi/Tesla auth flow)
- App builds and runs
</success_criteria>

<output>
After completion, create `.planning/phases/04-flutter-provider-split/04-02-SUMMARY.md`
</output>
