---
phase: 04-flutter-provider-split
plan: 03
type: execute
depends_on: ["04-02"]
files_modified: [mobile/lib/providers/connectivity_provider.dart, mobile/lib/providers/app_provider.dart, mobile/lib/main.dart]
---

<objective>
Extract ConnectivityProvider from AppProvider - Bluetooth, CarPlay, and offline queue management.

Purpose: Connectivity logic (device detection, auto-start triggers, offline queue) is a distinct concern that adds complexity to AppProvider. ConnectivityProvider will own all connectivity state and device management.
Output: ConnectivityProvider managing Bluetooth, CarPlay, network status, and offline queue.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-flutter-provider-split/04-01-SUMMARY.md
@.planning/phases/04-flutter-provider-split/04-02-SUMMARY.md
@mobile/lib/providers/app_provider.dart
@mobile/lib/services/bluetooth_service.dart
@mobile/lib/services/carplay_service.dart
@mobile/lib/services/offline_queue.dart

**From prior plans:**
- SettingsProvider and CarProvider extracted
- AppProvider takes dependencies via constructor
- ApiService available as provider

**Connectivity code in AppProvider:**
- State: `_isOnline`, `_queueLength`, `_isCarPlayConnected`, `_isBluetoothConnected`, `_connectedBluetoothDevice`, `_pendingUnknownDevice`
- Services: `_carPlay`, `_bluetooth`, `_offlineQueue`
- Methods: `_setupCarPlayListener`, `_setupBluetoothListener`, `_listenToConnectivity`, `_checkConnectivity`
- Queue: `refreshQueueLength`, `processQueue`
- Device: `clearPendingUnknownDevice`, callback `onUnknownDevice`
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ConnectivityProvider with device and network management</name>
  <files>mobile/lib/providers/connectivity_provider.dart</files>
  <action>
Create new ConnectivityProvider extending ChangeNotifier with:

**Constructor:**
- Accept `ApiService` for offline queue
- Accept `CarProvider` for `findCarByDeviceId` lookups
- `ConnectivityProvider(this._api, this._carProvider)`
- Initialize services in constructor

**Services to create:**
- `late CarPlayService _carPlay`
- `late BluetoothService _bluetooth`
- `late OfflineQueue _offlineQueue`

**State to move from AppProvider:**
- `bool _isOnline = true`
- `int _queueLength = 0`
- `bool _isCarPlayConnected = false`
- `bool _isBluetoothConnected = false`
- `String? _connectedBluetoothDevice`
- `String? _pendingUnknownDevice`

**Getters to move:**
- `isOnline`, `queueLength`
- `isCarPlayConnected`, `isBluetoothConnected`
- `connectedBluetoothDevice`, `pendingUnknownDevice`

**Callback:**
- `UnknownDeviceCallback? onUnknownDevice`

**Methods to move:**
- `_setupCarPlayListener()` -> `setupCarPlayListener()` (call from init)
- `_setupBluetoothListener()` -> `setupBluetoothListener()` (call from init)
- `_listenToConnectivity()` -> `listenToConnectivity()` (call from init)
- `_checkConnectivity()` -> `checkConnectivity()`
- `refreshQueueLength()`
- `processQueue()` - note: this refreshes active trip, will need callback
- `clearPendingUnknownDevice()`

**Init method:**
- `Future<void> init()` that sets up all listeners
- Called after construction in main.dart

**Callbacks for cross-provider communication:**
When CarPlay/Bluetooth connects and trip should start:
- Add `VoidCallback? onCarPlayConnected`
- Add `void Function(String deviceName)? onBluetoothDeviceConnected`
- AppProvider will set these to handle auto-start logic

**Do NOT move (stays in AppProvider):**
- `_tryAutoStartTrip()` - orchestrates trip start, uses multiple providers
- `_syncCarIdToNative()` - uses BackgroundService which is trip-related
- `linkDeviceAndStartTrip()` - starts trips, belongs with trip logic

Total ~250-300 lines expected.
  </action>
  <verify>File compiles: `cd mobile && flutter analyze lib/providers/connectivity_provider.dart`</verify>
  <done>ConnectivityProvider exists with Bluetooth, CarPlay, network, and queue management</done>
</task>

<task type="auto">
  <name>Task 2: Update AppProvider to delegate to ConnectivityProvider</name>
  <files>mobile/lib/providers/app_provider.dart</files>
  <action>
Modify AppProvider to use ConnectivityProvider:

1. **Add ConnectivityProvider dependency:**
   - Add `final ConnectivityProvider _connectivityProvider;` field
   - Update constructor: `AppProvider(this._settingsProvider, this._carProvider, this._connectivityProvider)`

2. **Remove connectivity state from AppProvider:**
   - Remove: `_isOnline`, `_queueLength`, `_isCarPlayConnected`, `_isBluetoothConnected`
   - Remove: `_connectedBluetoothDevice`, `_pendingUnknownDevice`
   - Remove: `_carPlay`, `_bluetooth`, `_offlineQueue` service instances
   - Remove: `onUnknownDevice` callback (it's now on ConnectivityProvider)

3. **Remove connectivity methods from AppProvider:**
   - Remove: `_setupCarPlayListener`, `_setupBluetoothListener`
   - Remove: `_listenToConnectivity`, `_checkConnectivity`
   - Remove: `refreshQueueLength`, `processQueue`
   - Remove: `clearPendingUnknownDevice`

4. **Update _init():**
   - Remove connectivity setup calls (ConnectivityProvider handles its own init)
   - Keep `_setupBackgroundListener()` - this is trip-related

5. **Update references throughout:**
   - `_isOnline` -> `_connectivityProvider.isOnline`
   - `_queueLength` -> `_connectivityProvider.queueLength`
   - `_isBluetoothConnected` -> `_connectivityProvider.isBluetoothConnected`
   - `_connectedBluetoothDevice` -> `_connectivityProvider.connectedBluetoothDevice`
   - `_bluetooth.getConnectedDevice()` -> `_connectivityProvider.getConnectedDevice()` (add this method)
   - Queue operations -> delegate to `_connectivityProvider`

6. **Set up cross-provider callbacks in _init():**
   ```dart
   _connectivityProvider.onCarPlayConnected = _tryAutoStartTrip;
   _connectivityProvider.onBluetoothDeviceConnected = (deviceName) {
     _syncCarIdToNative(deviceName);
     _tryAutoStartTrip();
   };
   _connectivityProvider.onUnknownDevice = onUnknownDevice;
   ```

7. **Keep in AppProvider:**
   - `_tryAutoStartTrip()` - orchestrates using multiple providers
   - `_syncCarIdToNative()` - uses BackgroundService
   - `linkDeviceAndStartTrip()` - trip lifecycle method
   - All trip start/end methods that use offline queue (they'll call `_connectivityProvider.processQueue()`)

AppProvider should shrink by ~150 lines from this extraction.
  </action>
  <verify>
1. `cd mobile && flutter analyze lib/providers/app_provider.dart` - no errors
2. Verify connectivity state removed: `grep -c "_isOnline\|_queueLength\|_isCarPlayConnected" mobile/lib/providers/app_provider.dart` should show only getter delegations
  </verify>
  <done>AppProvider delegates connectivity to ConnectivityProvider. Connectivity state and setup removed from AppProvider.</done>
</task>

<task type="auto">
  <name>Task 3: Update provider tree and verify integration</name>
  <files>mobile/lib/main.dart</files>
  <action>
Update main.dart MultiProvider setup:

1. **Add ConnectivityProvider after CarProvider:**
   ```dart
   ChangeNotifierProvider(
     create: (context) => ConnectivityProvider(
       context.read<ApiService>(),
       context.read<CarProvider>(),
     )..init(),  // Call init() immediately
   ),
   ```

2. **Update AppProvider creation:**
   ```dart
   ChangeNotifierProvider(
     create: (context) => AppProvider(
       context.read<SettingsProvider>(),
       context.read<CarProvider>(),
       context.read<ConnectivityProvider>(),
     ),
   ),
   ```

3. **Verify import:**
   ```dart
   import 'providers/connectivity_provider.dart';
   ```

4. **Check if any screens directly access connectivity state:**
   - `grep -r "isOnline\|queueLength\|isBluetoothConnected" mobile/lib/screens/`
   - If screens read from AppProvider, they continue to work (AppProvider has delegating getters)
   - If screens need direct access, update to use ConnectivityProvider

Provider order: SettingsProvider -> ApiService -> CarProvider -> ConnectivityProvider -> AppProvider
  </action>
  <verify>
1. `cd mobile && flutter analyze` - no errors
2. `cd mobile && flutter build ios --debug` - builds successfully
3. Bluetooth/CarPlay listeners still work (manual test if possible)
  </verify>
  <done>ConnectivityProvider in provider tree, cross-provider callbacks configured</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd mobile && flutter analyze` passes with no errors
- [ ] `cd mobile && flutter build ios --debug` succeeds
- [ ] ConnectivityProvider is ~250-300 lines
- [ ] AppProvider connectivity code removed
- [ ] Cross-provider callbacks set up for auto-start triggers
</verification>

<success_criteria>
- ConnectivityProvider exists and manages all connectivity state
- AppProvider delegates connectivity operations
- Bluetooth/CarPlay detection triggers auto-start via callbacks
- Offline queue works correctly
- App builds and runs
</success_criteria>

<output>
After completion, create `.planning/phases/04-flutter-provider-split/04-03-SUMMARY.md`
</output>
