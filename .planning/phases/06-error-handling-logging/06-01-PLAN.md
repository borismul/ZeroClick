---
phase: 06-error-handling-logging
plan: 01
type: execute
depends_on: []
files_modified: [mobile/ios/Runner/Services/Logger.swift, mobile/ios/Runner/AppDelegate.swift, mobile/ios/Runner/Services/LocationTrackingService.swift, mobile/ios/Runner/Services/MotionActivityHandler.swift, mobile/ios/Runner/Services/WatchConnectivityService.swift, mobile/ios/Runner/Services/LiveActivityManager.swift, watch/MileageWatch/MileageWatch/Logger.swift]
---

<objective>
Replace 92 iOS print statements and 23 Watch print statements with structured OSLog logging.

Purpose: Enable production-quality logging with log levels, subsystem filtering, and privacy controls.
Output: Logger utility in iOS and Watch apps, all print statements replaced with structured log calls.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md

**Current state:**
- iOS: 92 print() statements across 7 files
- Watch: 23 print() statements across 4 files
- No structured logging, no log levels, no filtering

**Target pattern:**
Use Apple's OSLog framework:
```swift
import OSLog

extension Logger {
    static let trip = Logger(subsystem: "com.zeroclick", category: "trip")
    static let location = Logger(subsystem: "com.zeroclick", category: "location")
    static let motion = Logger(subsystem: "com.zeroclick", category: "motion")
    static let watch = Logger(subsystem: "com.zeroclick", category: "watch")
    static let api = Logger(subsystem: "com.zeroclick", category: "api")
}

// Usage:
Logger.trip.info("Trip started: \(tripId)")
Logger.location.debug("GPS update: \(lat), \(lon)")
Logger.api.error("API call failed: \(error.localizedDescription)")
```

**Key files to modify:**
@mobile/ios/Runner/AppDelegate.swift
@mobile/ios/Runner/Services/LocationTrackingService.swift
@mobile/ios/Runner/Services/MotionActivityHandler.swift
@mobile/ios/Runner/Services/WatchConnectivityService.swift
@mobile/ios/Runner/Services/LiveActivityManager.swift
@watch/MileageWatch/MileageWatch/MileageViewModel.swift
@watch/MileageWatch/MileageWatch/APIClient.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create iOS Logger extension</name>
  <files>mobile/ios/Runner/Services/Logger.swift</files>
  <action>
Create a new Logger.swift file in mobile/ios/Runner/Services/:

```swift
import OSLog

extension Logger {
    private static let subsystem = Bundle.main.bundleIdentifier ?? "com.zeroclick"

    /// Trip lifecycle events (start, end, ping)
    static let trip = Logger(subsystem: subsystem, category: "trip")

    /// GPS/Location updates
    static let location = Logger(subsystem: subsystem, category: "location")

    /// Motion activity detection
    static let motion = Logger(subsystem: subsystem, category: "motion")

    /// Watch connectivity
    static let watch = Logger(subsystem: subsystem, category: "watch")

    /// API calls and responses
    static let api = Logger(subsystem: subsystem, category: "api")

    /// Live Activity updates
    static let activity = Logger(subsystem: subsystem, category: "activity")

    /// General app lifecycle
    static let app = Logger(subsystem: subsystem, category: "app")
}
```
  </action>
  <verify>test -f mobile/ios/Runner/Services/Logger.swift && echo "OK"</verify>
  <done>Logger.swift created with category-based loggers</done>
</task>

<task type="auto">
  <name>Task 2: Replace print statements in AppDelegate.swift</name>
  <files>mobile/ios/Runner/AppDelegate.swift</files>
  <action>
Add import at top: `import OSLog`

Replace all print() calls with appropriate Logger category:

Pattern replacements:
- `print("Starting trip...")` → `Logger.trip.info("Starting trip...")`
- `print("GPS update: ...")` → `Logger.location.debug("GPS update: ...")`
- `print("Motion: automotive")` → `Logger.motion.debug("Motion: automotive")`
- `print("Error: ...")` → `Logger.api.error("Error: ...")`
- `print("Watch: ...")` → `Logger.watch.debug("Watch: ...")`

For sensitive data, use privacy controls:
- `print("Token: \(token)")` → `Logger.api.debug("Token: \(token, privacy: .private)")`
- GPS coordinates can use `.public` (not sensitive for trip tracking)

Focus on replacing prints in these methods:
- startDriveTracking()
- stopDriveTracking()
- sendPing()
- handleMotionUpdate()
- WCSession delegate methods
  </action>
  <verify>cd mobile/ios && grep -c "print(" Runner/AppDelegate.swift | xargs -I {} test {} -lt 10 && echo "OK - reduced prints"</verify>
  <done>AppDelegate print statements replaced with OSLog</done>
</task>

<task type="auto">
  <name>Task 3: Replace print statements in iOS Services</name>
  <files>mobile/ios/Runner/Services/LocationTrackingService.swift, mobile/ios/Runner/Services/MotionActivityHandler.swift, mobile/ios/Runner/Services/WatchConnectivityService.swift, mobile/ios/Runner/Services/LiveActivityManager.swift</files>
  <action>
For each service file, add `import OSLog` and replace print() with appropriate Logger:

**LocationTrackingService.swift:**
- Use `Logger.location` for GPS updates
- Use `Logger.location.error()` for location errors
- Permissions: `Logger.app.info("Location permission: \(status)")`

**MotionActivityHandler.swift:**
- Use `Logger.motion` for activity updates
- `Logger.motion.debug("Activity: \(activity.automotive ? "automotive" : "other")")`

**WatchConnectivityService.swift:**
- Use `Logger.watch` for all watch communication
- `Logger.watch.info("Sending token to watch")`
- `Logger.watch.error("Watch session error: \(error)")`

**LiveActivityManager.swift:**
- Use `Logger.activity` for Live Activity updates
- `Logger.activity.info("Starting Live Activity")`
- `Logger.activity.debug("Updating activity with: \(distance)km")`
  </action>
  <verify>cd mobile/ios && for f in Runner/Services/LocationTrackingService.swift Runner/Services/MotionActivityHandler.swift Runner/Services/WatchConnectivityService.swift Runner/Services/LiveActivityManager.swift; do grep -c "print(" "$f" 2>/dev/null || echo "0"; done | awk '{s+=$1} END {print (s<5) ? "OK - services cleaned" : "FAIL - "s" prints remain"}'</verify>
  <done>All iOS service print statements replaced with OSLog</done>
</task>

<task type="auto">
  <name>Task 4: Create Watch Logger and replace prints</name>
  <files>watch/MileageWatch/MileageWatch/Logger.swift, watch/MileageWatch/MileageWatch/MileageViewModel.swift, watch/MileageWatch/MileageWatch/APIClient.swift</files>
  <action>
1. Create watch/MileageWatch/MileageWatch/Logger.swift:
```swift
import OSLog

extension Logger {
    private static let subsystem = "com.zeroclick.watch"

    static let api = Logger(subsystem: subsystem, category: "api")
    static let sync = Logger(subsystem: subsystem, category: "sync")
    static let ui = Logger(subsystem: subsystem, category: "ui")
}
```

2. In MileageViewModel.swift:
- Add `import OSLog`
- Replace `print("Refreshing...")` → `Logger.api.debug("Refreshing...")`
- Replace `print("Error: ...")` → `Logger.api.error("Error: ...")`
- Replace `print("Status: ...")` → `Logger.ui.info("Status: ...")`

3. In APIClient.swift:
- Add `import OSLog`
- Replace `print("Request: ...")` → `Logger.api.debug("Request: ...")`
- Replace `print("Response: ...")` → `Logger.api.debug("Response: ...")`
- Replace `print("Token refresh...")` → `Logger.sync.info("Token refresh...")`
  </action>
  <verify>cd watch/MileageWatch && grep -r "print(" MileageWatch/*.swift | wc -l | xargs -I {} test {} -lt 5 && echo "OK - watch cleaned"</verify>
  <done>Watch app Logger created and print statements replaced</done>
</task>

<task type="auto">
  <name>Task 5: Verify builds and add Logger.swift to Xcode projects</name>
  <files>mobile/ios/Runner.xcodeproj/project.pbxproj</files>
  <action>
1. Build iOS app to verify Logger.swift is picked up:
```bash
cd mobile/ios && xcodebuild -scheme Runner -sdk iphonesimulator -configuration Debug build CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO 2>&1 | grep -E "(error:|BUILD)"
```

2. Build Watch app to verify Logger.swift works:
```bash
cd watch/MileageWatch && xcodebuild -scheme MileageWatch -sdk watchsimulator -configuration Debug build CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO 2>&1 | grep -E "(error:|BUILD)"
```

If builds fail due to Logger.swift not being found, the files need to be added to the Xcode project file references. Swift files in existing directories are usually auto-discovered, but verify and fix if needed.
  </action>
  <verify>cd mobile/ios && xcodebuild -scheme Runner -sdk iphonesimulator -configuration Debug build CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO 2>&1 | grep "BUILD SUCCEEDED" && echo "iOS OK" && cd ../../watch/MileageWatch && xcodebuild -scheme MileageWatch -sdk watchsimulator -configuration Debug build CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO 2>&1 | grep "BUILD SUCCEEDED" && echo "Watch OK"</verify>
  <done>Both iOS and Watch apps build successfully with OSLog logging</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Logger.swift exists in iOS Services directory
- [ ] Logger.swift exists in Watch app
- [ ] AppDelegate.swift has < 10 print statements remaining
- [ ] iOS services have < 5 print statements combined
- [ ] Watch app has < 5 print statements combined
- [ ] iOS app builds successfully
- [ ] Watch app builds successfully
</verification>

<success_criteria>
- OSLog Logger extension created for iOS and Watch
- 92 iOS print statements reduced to < 10
- 23 Watch print statements reduced to < 5
- All apps build successfully
- Logs viewable in Console.app with category filtering
</success_criteria>

<output>
After completion, create `.planning/phases/06-error-handling-logging/06-01-SUMMARY.md`
</output>
