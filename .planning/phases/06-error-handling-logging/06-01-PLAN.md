---
phase: 06-error-handling-logging
plan: 01
type: execute
depends_on: []
files_modified: [mobile/pubspec.yaml, mobile/lib/main.dart, mobile/lib/core/logging/app_logger.dart, mobile/lib/core/logging/crashlytics_reporter.dart]
---

<objective>
Integrate Firebase Crashlytics into the Flutter mobile app for production crash reporting.

Purpose: Enable automatic crash collection and error tracking to diagnose production issues before App Store release.
Output: Working Crashlytics integration that captures crashes and errors via the existing AppLogger.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md

**Current state:**
- GoogleService-Info.plist already exists (Firebase configured on iOS)
- AppLogger exists with debug/info/warning/error levels
- No Firebase SDK in Flutter yet (no firebase_core, firebase_crashlytics)
- AppLogger logs to dart:developer in debug mode

**Key files:**
@mobile/pubspec.yaml
@mobile/lib/main.dart
@mobile/lib/core/logging/app_logger.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Firebase dependencies to pubspec.yaml</name>
  <files>mobile/pubspec.yaml</files>
  <action>
Add Firebase packages to dependencies section:
- firebase_core: ^3.10.0
- firebase_crashlytics: ^4.3.3

Note: Do NOT use firebase_analytics as it requires separate setup and ATT consent. Crashlytics works without analytics.

Run `flutter pub get` after adding dependencies.
  </action>
  <verify>cd mobile && flutter pub get succeeds without errors</verify>
  <done>firebase_core and firebase_crashlytics added to pubspec.yaml, pub get successful</done>
</task>

<task type="auto">
  <name>Task 2: Initialize Firebase and configure Crashlytics in main.dart</name>
  <files>mobile/lib/main.dart</files>
  <action>
1. Add imports:
   - import 'package:firebase_core/firebase_core.dart';
   - import 'package:firebase_crashlytics/firebase_crashlytics.dart';

2. Make main() async and add WidgetsFlutterBinding.ensureInitialized() BEFORE runApp()

3. Initialize Firebase:
   ```dart
   await Firebase.initializeApp();
   ```

4. Configure Crashlytics:
   ```dart
   // Pass all uncaught Flutter errors to Crashlytics
   FlutterError.onError = FirebaseCrashlytics.instance.recordFlutterFatalError;

   // Pass all uncaught asynchronous errors to Crashlytics
   PlatformDispatcher.instance.onError = (error, stack) {
     FirebaseCrashlytics.instance.recordError(error, stack, fatal: true);
     return true;
   };

   // Disable in debug mode to avoid polluting crash reports
   if (kDebugMode) {
     await FirebaseCrashlytics.instance.setCrashlyticsCollectionEnabled(false);
   }
   ```

5. Add import for kDebugMode:
   - import 'package:flutter/foundation.dart';

Important: The Firebase initialization must happen BEFORE runApp() but AFTER WidgetsFlutterBinding.ensureInitialized().
  </action>
  <verify>cd mobile && flutter build ios --debug --no-codesign - builds without errors</verify>
  <done>Firebase initialized, Crashlytics configured with debug mode disabled, Flutter error hooks set</done>
</task>

<task type="auto">
  <name>Task 3: Integrate Crashlytics with existing AppLogger</name>
  <files>mobile/lib/core/logging/app_logger.dart, mobile/lib/core/logging/crashlytics_reporter.dart</files>
  <action>
1. Create new file `mobile/lib/core/logging/crashlytics_reporter.dart`:
   ```dart
   import 'package:firebase_crashlytics/firebase_crashlytics.dart';
   import 'package:flutter/foundation.dart';

   class CrashlyticsReporter {
     static final CrashlyticsReporter _instance = CrashlyticsReporter._internal();
     factory CrashlyticsReporter() => _instance;
     CrashlyticsReporter._internal();

     bool get isEnabled => !kDebugMode;

     /// Record a non-fatal error
     void recordError(Object error, StackTrace? stackTrace, {String? reason}) {
       if (!isEnabled) return;
       FirebaseCrashlytics.instance.recordError(
         error,
         stackTrace ?? StackTrace.current,
         reason: reason,
       );
     }

     /// Log a message as breadcrumb (visible in crash context)
     void log(String message) {
       if (!isEnabled) return;
       FirebaseCrashlytics.instance.log(message);
     }

     /// Set user identifier for crash grouping
     void setUserId(String userId) {
       if (!isEnabled) return;
       FirebaseCrashlytics.instance.setUserIdentifier(userId);
     }

     /// Set custom key-value for crash context
     void setCustomKey(String key, Object value) {
       if (!isEnabled) return;
       FirebaseCrashlytics.instance.setCustomKey(key, value);
     }
   }
   ```

2. Modify `app_logger.dart` to report errors to Crashlytics:
   - Add import: `import 'crashlytics_reporter.dart';`
   - Add field: `final _crashlytics = CrashlyticsReporter();`
   - In the `error()` method, after logging to developer console, add:
     ```dart
     _crashlytics.recordError(error ?? message, stackTrace, reason: message);
     ```
   - In the `warning()` method, add breadcrumb logging:
     ```dart
     _crashlytics.log('[WARNING] $tag: $message');
     ```

This ensures all errors logged via AppLogger.error() are automatically sent to Crashlytics in production.
  </action>
  <verify>cd mobile && dart analyze lib/core/logging/ - no errors</verify>
  <done>CrashlyticsReporter created, AppLogger integrated to report errors and breadcrumbs to Crashlytics</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd mobile && flutter pub get` succeeds
- [ ] `cd mobile && flutter build ios --debug --no-codesign` compiles
- [ ] `cd mobile && dart analyze` passes with no errors
- [ ] Firebase imports are correct
- [ ] Crashlytics is disabled in debug mode (kDebugMode check)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Firebase Crashlytics integrated with Flutter app
- Errors logged via AppLogger.error() are reported to Crashlytics in production
- Debug mode does NOT send crashes (to avoid polluting data)
</success_criteria>

<output>
After completion, create `.planning/phases/06-error-handling-logging/06-01-SUMMARY.md`:

# Phase 6 Plan 01: Firebase Crashlytics Integration Summary

**[One-liner summary of what was accomplished]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 06-02-PLAN.md (iOS/Watch logging modernization)
</output>
