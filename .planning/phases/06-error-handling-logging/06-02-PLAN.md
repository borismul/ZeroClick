---
phase: 06-error-handling-logging
plan: 02
type: execute
depends_on: [06-01]
files_modified: [mobile/pubspec.yaml, mobile/lib/main.dart, mobile/ios/Podfile, mobile/ios/Runner/AppDelegate.swift, mobile/android/build.gradle, mobile/android/app/build.gradle]
---

<objective>
Integrate Firebase Crashlytics for production crash reporting in Flutter and iOS native code.

Purpose: Capture crashes, non-fatal errors, and custom logs for production debugging.
Output: Crashlytics SDK integrated, crashes auto-reported, custom error logging enabled.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md

**Current state:**
- No crash reporting in production
- Errors logged to console only
- No visibility into production issues

**Target:**
- Crashes automatically captured and reported
- Non-fatal errors logged with context
- Custom keys for debugging (user_id, trip_id, car_id)
- dSYM upload for symbolicated stack traces

**Key files:**
@mobile/pubspec.yaml
@mobile/lib/main.dart
@mobile/ios/Podfile
@mobile/ios/Runner/AppDelegate.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Firebase Crashlytics dependencies</name>
  <files>mobile/pubspec.yaml</files>
  <action>
Add to pubspec.yaml dependencies:

```yaml
dependencies:
  firebase_core: ^3.8.1
  firebase_crashlytics: ^4.2.1
```

Run `flutter pub get` after adding.

Note: Firebase may already be partially configured. Check if firebase_core exists.
If firebase_core already exists, just add firebase_crashlytics.
  </action>
  <verify>cd mobile && grep "firebase_crashlytics" pubspec.yaml && flutter pub get && echo "OK"</verify>
  <done>Firebase Crashlytics dependency added to pubspec.yaml</done>
</task>

<task type="auto">
  <name>Task 2: Initialize Crashlytics in main.dart</name>
  <files>mobile/lib/main.dart</files>
  <action>
Add Crashlytics initialization in main():

```dart
import 'package:firebase_core/firebase_core.dart';
import 'package:firebase_crashlytics/firebase_crashlytics.dart';
import 'dart:async';

void main() async {
  // Catch Flutter framework errors
  await runZonedGuarded(() async {
    WidgetsFlutterBinding.ensureInitialized();
    await Firebase.initializeApp();

    // Pass all uncaught Flutter errors to Crashlytics
    FlutterError.onError = FirebaseCrashlytics.instance.recordFlutterFatalError;

    // Pass uncaught async errors to Crashlytics
    PlatformDispatcher.instance.onError = (error, stack) {
      FirebaseCrashlytics.instance.recordError(error, stack, fatal: true);
      return true;
    };

    runApp(const MyApp());
  }, (error, stack) {
    FirebaseCrashlytics.instance.recordError(error, stack, fatal: true);
  });
}
```

Also add a helper class for non-fatal error logging:

```dart
// In lib/core/logging/crashlytics_logger.dart
import 'package:firebase_crashlytics/firebase_crashlytics.dart';

class CrashlyticsLogger {
  static void setUserIdentifier(String userId) {
    FirebaseCrashlytics.instance.setUserIdentifier(userId);
  }

  static void setCustomKey(String key, dynamic value) {
    FirebaseCrashlytics.instance.setCustomKey(key, value);
  }

  static void log(String message) {
    FirebaseCrashlytics.instance.log(message);
  }

  static Future<void> recordError(
    dynamic exception,
    StackTrace? stack, {
    String? reason,
    bool fatal = false,
  }) async {
    await FirebaseCrashlytics.instance.recordError(
      exception,
      stack,
      reason: reason,
      fatal: fatal,
    );
  }
}
```
  </action>
  <verify>cd mobile && grep "FirebaseCrashlytics" lib/main.dart && echo "OK"</verify>
  <done>Crashlytics initialized with error handlers in main.dart</done>
</task>

<task type="auto">
  <name>Task 3: Configure iOS for Crashlytics</name>
  <files>mobile/ios/Podfile, mobile/ios/Runner/AppDelegate.swift</files>
  <action>
1. Ensure Podfile has Firebase pods. Run:
```bash
cd mobile/ios && pod install
```

2. In AppDelegate.swift, ensure FirebaseApp.configure() is called.
   This may already exist if Firebase was previously set up.
   
   Check for existing Firebase initialization:
   ```swift
   import Firebase
   
   // In application(_:didFinishLaunchingWithOptions:)
   FirebaseApp.configure()
   ```

3. Add dSYM upload script to Xcode build phases (manual step - document for user):
   - In Xcode: Runner > Build Phases > New Run Script Phase
   - Script: `"${PODS_ROOT}/FirebaseCrashlytics/run"`
   - Input Files:
     - `${DWARF_DSYM_FOLDER_PATH}/${DWARF_DSYM_FILE_NAME}/Contents/Resources/DWARF/${TARGET_NAME}`
     - `$(SRCROOT)/$(BUILT_PRODUCTS_DIR)/$(INFOPLIST_PATH)`
  </action>
  <verify>cd mobile/ios && pod install 2>&1 | grep -i "crashlytics\|firebase" | head -3 && echo "OK"</verify>
  <done>iOS configured for Crashlytics with pods installed</done>
</task>

<task type="auto">
  <name>Task 4: Add error context to providers</name>
  <files>mobile/lib/providers/trip_provider.dart, mobile/lib/providers/car_provider.dart</files>
  <action>
Add Crashlytics context when trips/cars are active:

In trip_provider.dart (or wherever trip state is managed):
```dart
import 'package:firebase_crashlytics/firebase_crashlytics.dart';

// When trip starts:
void _onTripStarted(String tripId) {
  FirebaseCrashlytics.instance.setCustomKey('active_trip_id', tripId);
  FirebaseCrashlytics.instance.log('Trip started: $tripId');
}

// When trip ends:
void _onTripEnded() {
  FirebaseCrashlytics.instance.setCustomKey('active_trip_id', '');
}
```

In car_provider.dart:
```dart
// When car is selected:
void _onCarSelected(String carId, String carBrand) {
  FirebaseCrashlytics.instance.setCustomKey('selected_car_id', carId);
  FirebaseCrashlytics.instance.setCustomKey('car_brand', carBrand);
}
```

In auth handling:
```dart
// After successful login:
void _onUserAuthenticated(String userId) {
  FirebaseCrashlytics.instance.setUserIdentifier(userId);
}
```
  </action>
  <verify>cd mobile && grep -r "setCustomKey\|setUserIdentifier" lib/providers/ | head -3 && echo "OK"</verify>
  <done>Crashlytics context added to providers for debugging</done>
</task>

<task type="auto">
  <name>Task 5: Build and verify Crashlytics integration</name>
  <files>mobile/lib/main.dart</files>
  <action>
1. Build iOS app:
```bash
cd mobile && flutter build ios --debug
```

2. Check that Crashlytics initializes without errors by looking at build output.

3. Add a test crash button (development only) to verify Crashlytics works:
```dart
// Temporary - in a debug screen
ElevatedButton(
  onPressed: () => FirebaseCrashlytics.instance.crash(),
  child: Text('Test Crash'),
)
```

Note: The test crash button should be removed or guarded with kDebugMode before release.
  </action>
  <verify>cd mobile && flutter build ios --debug 2>&1 | grep -E "(error:|BUILD)" | head -5 || echo "Build check"</verify>
  <done>Crashlytics integration verified with successful build</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] firebase_crashlytics in pubspec.yaml
- [ ] Crashlytics initialized in main.dart
- [ ] FlutterError.onError connected to Crashlytics
- [ ] iOS pods installed
- [ ] Custom keys added for trip_id, car_id, user_id
- [ ] App builds successfully
</verification>

<success_criteria>
- Firebase Crashlytics SDK integrated
- Crashes automatically reported
- Non-fatal errors logged with context
- Custom keys set for debugging (trip, car, user)
- Both iOS and Flutter builds succeed
</success_criteria>

<output>
After completion, create `.planning/phases/06-error-handling-logging/06-02-SUMMARY.md`
</output>
