---
phase: 02-ios-native-architecture
plan: 03
type: execute
depends_on: ["02-02"]
files_modified:
  - mobile/ios/Runner/Services/LiveActivityManager.swift
  - mobile/ios/Runner/Services/LiveActivityManagerProtocol.swift
domain: ios-native
---

<objective>
Extract Live Activity (Dynamic Island/Lock Screen) functionality from AppDelegate into a dedicated LiveActivityManager.

Purpose: Isolate ActivityKit handling and background task management into a focused service.
Output: LiveActivityManager.swift with protocol for controlling trip display on Lock Screen and Dynamic Island.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-ios-native-architecture/02-02-SUMMARY.md
@mobile/ios/Runner/AppDelegate.swift

**Extracting from AppDelegate.swift:**
- Lines 692-733: startLiveActivity() - background task setup and main thread dispatch
- Lines 735-785: startLiveActivityAsync() - ActivityKit availability check, ending existing activities, creating new activity
- Lines 787-800: updateLiveActivity() - updating activity state
- Lines 803-827: endLiveActivity() - ending activity with dismissal policy

**Also need to reference:**
- TripActivityAttributes (should be in separate file or defined inline)
- currentActivityStorage pattern

**Key iOS version requirements:**
- Live Activity requires iOS 16.2+
- Use @available guards throughout
- Fail gracefully on older iOS versions

**Established patterns from 02-01/02-02:**
- Protocol-based dependency injection
- Delegate pattern for callbacks (not needed here - one-way control)
- MARK comments for organization
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create LiveActivityManagerProtocol</name>
  <files>mobile/ios/Runner/Services/LiveActivityManagerProtocol.swift</files>
  <action>
Create protocol file defining the Live Activity interface:

```swift
import Foundation

/// Data for updating the Live Activity display
struct TripActivityState {
    let distanceKm: Double
    let durationMinutes: Int
    let avgSpeed: Double
    let startTime: Date
    let isActive: Bool
}

protocol LiveActivityManagerProtocol: AnyObject {
    /// Whether a Live Activity is currently running
    var isActivityRunning: Bool { get }

    /// Start a new Live Activity for a trip
    /// - Parameters:
    ///   - carName: Display name for the car (e.g., "Audi A3" or "Auto")
    ///   - startTime: When the trip started
    func startActivity(carName: String, startTime: Date)

    /// Update the Live Activity with current trip stats
    /// - Parameter state: Current trip state
    func updateActivity(state: TripActivityState)

    /// End the Live Activity
    /// - Parameter keepVisibleForSeconds: How long to keep visible after ending (default 300)
    func endActivity(keepVisibleForSeconds: TimeInterval)
}

// Default parameter extension
extension LiveActivityManagerProtocol {
    func endActivity() {
        endActivity(keepVisibleForSeconds: 300)
    }
}
```

No delegate needed - Live Activity is a one-way display. AppDelegate controls when to start/update/end.
  </action>
  <verify>File exists at mobile/ios/Runner/Services/LiveActivityManagerProtocol.swift</verify>
  <done>Protocol file created with TripActivityState struct and LiveActivityManagerProtocol definition</done>
</task>

<task type="auto">
  <name>Task 2: Create LiveActivityManager implementation</name>
  <files>mobile/ios/Runner/Services/LiveActivityManager.swift</files>
  <action>
Extract Live Activity functionality from AppDelegate:

1. Move these methods from AppDelegate:
   - `startLiveActivity()` (lines 696-733)
   - `startLiveActivityAsync()` (lines 735-785)
   - `updateLiveActivity()` (lines 787-800)
   - `endLiveActivity()` (lines 803-827)

2. Service should:
   - Implement `LiveActivityManagerProtocol`
   - Own the `currentActivityStorage` (typed as `Activity<TripActivityAttributes>?`)
   - Handle iOS 16.2+ availability checking
   - Manage background task for activity setup
   - End existing activities before starting new ones

3. Key behaviors to preserve:
   - `@available(iOS 16.2, *)` guards on async methods
   - Background task request to ensure completion in background
   - Fire-and-forget for ending existing activities
   - Dismissal policy of `.after(.now + 300)` on end

4. TripActivityAttributes should already exist somewhere in the project (likely in a separate file). If not, we need to locate it or create it.

Structure:
```swift
import ActivityKit
import UIKit

@available(iOS 16.2, *)
class LiveActivityManager: LiveActivityManagerProtocol {
    // MARK: - Properties
    private var currentActivity: Activity<TripActivityAttributes>?

    var isActivityRunning: Bool {
        return currentActivity != nil
    }

    // MARK: - Activity Control
    func startActivity(carName: String, startTime: Date) {
        // Request background time
        // Dispatch to main thread
        // Call async start
    }

    func updateActivity(state: TripActivityState) { ... }

    func endActivity(keepVisibleForSeconds: TimeInterval) { ... }

    // MARK: - Private
    private func startActivityAsync(carName: String, startTime: Date) async { ... }
}

// Fallback for older iOS
class LiveActivityManagerFallback: LiveActivityManagerProtocol {
    var isActivityRunning: Bool { false }
    func startActivity(carName: String, startTime: Date) {
        print("[LiveActivity] iOS 16.2+ required")
    }
    func updateActivity(state: TripActivityState) {}
    func endActivity(keepVisibleForSeconds: TimeInterval) {}
}
```

Factory function:
```swift
func createLiveActivityManager() -> LiveActivityManagerProtocol {
    if #available(iOS 16.2, *) {
        return LiveActivityManager()
    } else {
        return LiveActivityManagerFallback()
    }
}
```
  </action>
  <verify>Build succeeds: `cd /Users/boris/zeroclick/mobile/ios && xcodebuild -project Runner.xcodeproj -scheme Runner -sdk iphoneos -configuration Debug build 2>&1 | grep -E "(error:|BUILD SUCCEEDED|BUILD FAILED)" | head -5`</verify>
  <done>LiveActivityManager.swift created with iOS 16.2+ support and fallback, build succeeds</done>
</task>

<task type="auto">
  <name>Task 3: Add Live Activity files to Xcode project</name>
  <files>mobile/ios/Runner.xcodeproj/project.pbxproj</files>
  <action>
Add the new Swift files to the Xcode project Services group.

Follow same pattern established in 02-01:
- Add LiveActivityManagerProtocol.swift to Services group
- Add LiveActivityManager.swift to Services group
- Ensure both are in Compile Sources build phase

After adding, verify all 6 service files are in the project:
1. LocationTrackingServiceProtocol.swift
2. LocationTrackingService.swift
3. MotionActivityHandlerProtocol.swift
4. MotionActivityHandler.swift
5. LiveActivityManagerProtocol.swift
6. LiveActivityManager.swift
  </action>
  <verify>Build succeeds and all 6 files compile: `cd /Users/boris/zeroclick/mobile/ios && xcodebuild -project Runner.xcodeproj -scheme Runner -sdk iphoneos -configuration Debug build 2>&1 | grep -E "(error:|BUILD SUCCEEDED|BUILD FAILED)" | head -5`</verify>
  <done>Live Activity files added to Xcode project, build succeeds with all 6 service files</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] LiveActivityManagerProtocol.swift defines TripActivityState and protocol
- [ ] LiveActivityManager.swift implements protocol with ActivityKit
- [ ] iOS 16.2+ availability properly handled with fallback
- [ ] Background task request preserved for reliable activity start
- [ ] Xcode project builds without errors
- [ ] All 6 service files compile together
</verification>

<success_criteria>
- All tasks completed
- Xcode build succeeds
- Live Activity functionality properly encapsulated
- iOS version compatibility maintained with fallback
- AppDelegate NOT modified yet (integration in later plan)
</success_criteria>

<output>
After completion, create `.planning/phases/02-ios-native-architecture/02-03-SUMMARY.md`
</output>
