---
phase: 06.1-firestore-optimization
plan: 02
subsystem: api, watch
tags: [firestore, polling, cache, swift, python, performance]

# Dependency graph
requires:
  - phase: 06.1-01
    provides: Smart polling intervals, cursor pagination
provides:
  - Watch app on-open refresh (zero idle reads)
  - Single cache write per webhook ping
affects: [firestore-costs, watch-app, webhook-service]

# Tech tracking
tech-stack:
  added: []
  patterns: [on-demand-refresh, single-write-pattern]

key-files:
  modified:
    - watch/MileageWatch/MileageWatch/MileageViewModel.swift
    - watch/MileageWatch/MileageWatch/ContentView.swift
    - api/services/webhook_service.py

key-decisions:
  - "On-open refresh via scenePhase observer instead of background timer"
  - "Single cache write at end of handle_ping() using result/clear_cache pattern"

patterns-established:
  - "On-demand refresh: Refresh data only when user opens app, not on timer"
  - "Single-write pattern: Accumulate state in memory, persist once at function end"

issues-created: []

# Metrics
duration: 8min
completed: 2026-01-20
---

# Phase 6.1 Plan 02: Firestore Optimization - On-Open Refresh & Write Consolidation

**Eliminated idle polling entirely and reduced webhook writes from 2-5 per ping to exactly 1**

## Performance

- **Duration:** 8 min
- **Started:** 2026-01-20
- **Completed:** 2026-01-20
- **Tasks:** 2
- **Files modified:** 3

## Accomplishments

- Watch app: On-open refresh only (zero idle Firestore reads)
- Webhook ping: Single cache write at end of processing (was 2-5 writes scattered throughout)
- Removed 5-minute background timer completely

## Task Commits

Each task was committed atomically:

1. **Task 1: Watch app on-open refresh** - `73c26a4` (perf)
2. **Task 2: Consolidate cache writes** - `d062d72` (perf)

## Files Created/Modified

- `watch/MileageWatch/MileageWatch/MileageViewModel.swift` - Removed refreshTimer, added refreshOnAppear()
- `watch/MileageWatch/MileageWatch/ContentView.swift` - Added scenePhase observer
- `api/services/webhook_service.py` - Refactored handle_ping() for single cache write

## Decisions Made

- **On-open refresh:** Use `scenePhase == .active` to trigger refresh instead of timer - simpler and more efficient
- **Single-write pattern:** All state changes accumulate in `cache` dict, `clear_cache` flag determines final action

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None

## Estimated Impact

| Metric | After 06.1-01 | After 06.1-02 |
|--------|---------------|---------------|
| Idle watch reads/hour | 41 | **0** |
| Writes per ping | 2-5 | **1** |
| Writes per trip (60 pings) | 120-300 | **~60** |

## Combined Phase 6.1 Impact

| Metric | Before 06.1 | After 06.1 |
|--------|-------------|------------|
| Daily reads | ~590,000 | **~500** |
| Writes per trip | 120-300 | **~60** |
| Monthly read cost | ~$2.40 | **~$0.002** |

## Next Phase Readiness

- Firestore optimization phase complete
- Ready to continue with Phase 6: Error Handling & Logging

---
*Phase: 06.1-firestore-optimization*
*Completed: 2026-01-20*
