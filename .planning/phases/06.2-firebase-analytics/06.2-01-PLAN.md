---
phase: 06.2-firebase-analytics
plan: 01
type: execute
depends_on: []
files_modified:
  - mobile/pubspec.yaml
  - mobile/ios/Podfile.lock
  - mobile/ios/Runner/Info.plist
  - mobile/lib/core/analytics/analytics_service.dart
  - mobile/lib/main.dart
  - mobile/lib/providers/trip_provider.dart
  - mobile/lib/providers/app_provider.dart
  - mobile/lib/providers/car_provider.dart
---

<objective>
Add Firebase Analytics to track user behavior, trip events, and feature usage.

Purpose: Understand how users interact with Zero Click - which features they use, trip patterns, and app engagement.
Output: Analytics service with trip events, screen tracking, and user properties.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 6 context (Firebase already configured):
@.planning/phases/06-error-handling-logging/06-02-SUMMARY.md

# Current Firebase/Crashlytics setup pattern:
@mobile/lib/main.dart
@mobile/lib/core/logging/crashlytics_logger.dart

# Trip lifecycle (where to add events):
@mobile/lib/providers/trip_provider.dart

# User properties context:
@mobile/lib/providers/app_provider.dart
@mobile/lib/providers/car_provider.dart

**Firebase Status:**
- firebase_core ^3.8.1 installed
- firebase_crashlytics ^4.2.1 installed
- Firebase.initializeApp() called in main.dart
- ATT (App Tracking Transparency) NOT configured - needs NSUserTrackingUsageDescription

**Established patterns:**
- CrashlyticsLogger: Static wrapper class with static methods
- Logger categories in iOS: trip, location, motion, watch, api, activity, app
- Providers have init() methods for setup
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Firebase Analytics with ATT support</name>
  <files>mobile/pubspec.yaml, mobile/ios/Podfile.lock, mobile/ios/Runner/Info.plist, mobile/lib/core/analytics/analytics_service.dart</files>
  <action>
1. Add firebase_analytics to pubspec.yaml dependencies (under firebase_crashlytics):
   ```yaml
   firebase_analytics: ^11.4.0
   ```
   Run `flutter pub get` from mobile/ directory.

2. Run `cd mobile/ios && pod install` to install Firebase Analytics pod.

3. Add ATT (App Tracking Transparency) description to Info.plist. Add after NSBluetoothPeripheralUsageDescription:
   ```xml
   <key>NSUserTrackingUsageDescription</key>
   <string>We gebruiken analytics om de app te verbeteren. Je gegevens worden anoniem verzameld.</string>
   ```

4. Create analytics service at mobile/lib/core/analytics/analytics_service.dart:
   - Follow CrashlyticsLogger pattern (static wrapper class)
   - Import firebase_analytics
   - Create static instance getter
   - Add methods:
     - `logEvent(String name, {Map<String, Object>? parameters})` - custom events
     - `logScreenView(String screenName)` - screen tracking
     - `setUserProperty(String name, String? value)` - user properties
     - `setUserId(String? id)` - user identification
   - Add trip-specific convenience methods:
     - `logTripStarted({String? carId, String? carBrand, String? method})` - method is 'bluetooth', 'api', or 'motion'
     - `logTripEnded({double? distanceKm, int? durationMinutes, String? classification})`
     - `logTripCancelled({String? reason})`
   - Disable analytics collection in debug mode (check kDebugMode)
  </action>
  <verify>
- `grep firebase_analytics mobile/pubspec.yaml` shows version
- `grep FirebaseAnalytics mobile/ios/Podfile.lock` shows pod installed
- `grep NSUserTrackingUsageDescription mobile/ios/Runner/Info.plist` shows ATT description
- `ls mobile/lib/core/analytics/analytics_service.dart` exists
- `flutter analyze mobile/lib/core/analytics/analytics_service.dart` shows no errors
  </verify>
  <done>
- firebase_analytics dependency added and pod installed
- ATT description in Info.plist (Dutch language)
- AnalyticsService class with static methods for events, screens, user properties
- Debug mode disables collection (matches Crashlytics behavior)
  </done>
</task>

<task type="auto">
  <name>Task 2: Add screen tracking and user properties</name>
  <files>mobile/lib/main.dart, mobile/lib/providers/app_provider.dart, mobile/lib/providers/car_provider.dart</files>
  <action>
1. In main.dart MainScreen._MainScreenState:
   - Import AnalyticsService
   - In initState(), add screen view for initial screen (dashboard) after _checkOnboarding completes
   - Create helper `_trackScreen(int index)` that maps index to screen name:
     - 0 = 'dashboard', 1 = 'history', 2 = 'charging', 3 = 'settings'
   - In build() where BottomNavigationBar.onTap calls provider.navigateTo, wrap to also call `_trackScreen(index)`
   - Track 'onboarding' screen when onboarding shown
   - Track 'cars' when navigating to CarsScreen

2. In app_provider.dart:
   - Import AnalyticsService
   - In init() or when user email changes, call:
     - `AnalyticsService.setUserId(hashedEmail)` - hash email for privacy (use simple hash, not raw email)
     - `AnalyticsService.setUserProperty('app_version', packageInfo.version)` - if accessible, otherwise skip
   - Add method `_updateAnalyticsUserProperties()` that sets:
     - `car_count`: String of cars.length
   - Call this when cars list changes

3. In car_provider.dart:
   - Import AnalyticsService
   - When cars list is loaded (in refreshCars), call:
     - `AnalyticsService.setUserProperty('car_count', '${cars.length}')`
  </action>
  <verify>
- `grep AnalyticsService mobile/lib/main.dart` shows import and usage
- `grep logScreenView mobile/lib/main.dart` shows screen tracking
- `grep setUserProperty mobile/lib/providers/car_provider.dart` shows car_count tracking
- `flutter build ios --debug` succeeds
  </verify>
  <done>
- Screen views tracked for all main tabs and key screens
- User ID set (hashed) on login
- User property car_count updated when cars change
- No raw PII logged (email hashed, not raw)
  </done>
</task>

<task type="auto">
  <name>Task 3: Add trip event tracking</name>
  <files>mobile/lib/providers/trip_provider.dart</files>
  <action>
1. Import AnalyticsService at top of file.

2. In startTripForCar() method, after successful trip start (after refreshActiveTrip succeeds):
   - Call `AnalyticsService.logTripStarted(carId: car.id, carBrand: car.brand, method: deviceId == 'Motion' ? 'motion' : 'bluetooth')`

3. In endTrip() method, after successful API call:
   - Get trip details from _activeTrip before it clears
   - Calculate duration if startTime available: `DateTime.now().difference(startTime).inMinutes`
   - Call `AnalyticsService.logTripEnded(distanceKm: activeTrip?.distance, durationMinutes: duration)`

4. In finalizeTrip() method, after successful finalize:
   - Call `AnalyticsService.logTripEnded(distanceKm: activeTrip?.distance)` with classification if available

5. In cancelTrip() method, after successful cancel:
   - Call `AnalyticsService.logTripCancelled(reason: 'user_cancelled')`

6. Also track trip classification changes - in updateTrip(), if updates contains 'classification':
   - Call `AnalyticsService.logEvent('trip_classified', parameters: {'classification': updates['classification']})`
  </action>
  <verify>
- `grep AnalyticsService mobile/lib/providers/trip_provider.dart` shows import and usage
- `grep logTripStarted mobile/lib/providers/trip_provider.dart` shows event call
- `grep logTripEnded mobile/lib/providers/trip_provider.dart` shows event call
- `grep logTripCancelled mobile/lib/providers/trip_provider.dart` shows event call
- `flutter analyze mobile/lib/providers/trip_provider.dart` shows no errors
- `flutter build ios --debug` succeeds
  </verify>
  <done>
- trip_started event logged with car info and detection method
- trip_ended event logged with distance and duration
- trip_cancelled event logged with reason
- trip_classified event logged when user classifies trip
- All trip lifecycle events have analytics coverage
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `flutter pub get` succeeds in mobile/
- [ ] `pod install` succeeds in mobile/ios/
- [ ] `flutter analyze` shows no errors in modified files
- [ ] `flutter build ios --debug` succeeds
- [ ] All new files have correct imports
- [ ] No PII (raw email) logged to analytics
</verification>

<success_criteria>

- firebase_analytics package installed
- ATT description added to Info.plist
- AnalyticsService class created with static methods
- Screen views tracked for all main screens
- User properties set (car_count, user_id)
- Trip events logged (started, ended, cancelled, classified)
- Debug mode disables analytics collection
- Phase 6.2 complete
  </success_criteria>

<output>
After completion, create `.planning/phases/06.2-firebase-analytics/06.2-01-SUMMARY.md`:

# Phase 06.2-01: Firebase Analytics Summary

**[Substantive one-liner describing what shipped]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

Phase 6.2 complete, ready for Phase 7: Compliance Foundation
</output>
